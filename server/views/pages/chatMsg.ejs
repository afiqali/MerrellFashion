<!doctype html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
<script src="/javascripts/socket.io.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<% include ../partials/javascript %>
<% include ../partials/stylesheet %>
</head>
<style>
img {
    height: 100px;
    width: 150px;
}
#chatroom {
    padding: 30px 30px 20px;
    border-bottom: 2px solid white;
    overflow-y: scroll;
    height: 350px;
}
#border {
    border-style: solid;
    border-color: grey;
}
.chat-message-type {
    background-color: #F2F4F4;
    padding-bottom: 0px !important;
    padding: 10px;
}
.chat {
    max-width: 800px;
    background: #F2F5F8;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
    color: #434651;
}
.chat-header {
    padding: 20px;
    border-bottom: 2px solid white;
}
.clearfix:after {
	visibility: hidden;
	display: block;
	font-size: 0;
	content: " ";
	clear: both;
	height: 0;
}
.profilepic {
    height: 65px;
    width: 65px;
    float: left;
}
.chat-about {
    float: left;
    padding-left: 20px;
    margin-top: 6px;
}
.chat-with {
    font-weight: bold;
    font-size: 20px;
}
.dropbtn {
    background-color: #F2F5F8;
    color: black;
    padding: 5px;
    font-size: 20px;
    font-weight: bold;
    border: none;
    cursor: pointer;
}
.dropdown {
    float: right;
    position: relative;
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f1f1f1;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    right: 0;
    z-index: 1;
}
.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}
.chat-message {
    padding: 10px;
}
.fa-file-o, .fa-file-image-o {
    font-size: 16px;
    color: gray;
    cursor: pointer;
}
#send {
    float: right;
}
</style>
<body>
<% include ../partials/header %>
<div class="container">
    <br>
    <div class="panel panel-default">
        <div class="panel-heading"><h3 style="text-align: center">Messages</h3></div>
        <div class="panel-body"><img alt="" align="left" src="/publicPRODUCT/images/<%= productlist.imageName %>">
        <strong><h3><%= productlist.ItemName%></h3></strong>
        <p><%= productlist.Description%></p></div>
        <form action="/messages/<%= productlist.Itemid%>" class="makeOffer" method="POST">
        <div class="moBtn">
        <div class="input-group u-horizontal-full aC-i">
        <span class="input-group-addon">S$</span>
        <input type="number" step="0.01" min="0" name="offerAmount" class="form-control u-horizontal-full" required="" value=<%= productlist.price%>>
        </div>
        </div>    
        <button type="submit" id="makeOfferButton" class="btn btn-block b-r text-small b-r">
        <span>Make Offer</span>
        </button>
    </form>
        <button id="makeOfferButton" class="btn btn-block b-r text-small b-r">
            <span><a href="http://localhost:3000/payment/<%= productlist.Itemid%>" id="#offer">Make Offer</a></span>
        </button>
    </div>

    <div class="chat" id="border">
        <div class="chat-header clearfix">
            <img class="profilepic" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/195612/chat_avatar_01_green.jpg" alt="avatar" />
            <div class="chat-about">
                <div class="chat-with">Chat with <%= user.name %></div>
            </div>
            <div class="dropdown">
                <button onclick="myFunction()" class="dropbtn">...</button>
                  <div id="myDropdown" class="dropdown-content">
                    <a href="#">Report User</a>
                    <a href="#">Leave a Feedback</a>
                  </div>
                </div>
        </div>
        <div id="chatroom">
            <div id="messages">
                    <%data.forEach(function(msg){%>
                       <h4><%=msg.name%></h4>  <p> <%=msg.message%> </p>
                    <%})%>
            </div>
        </div>
        <div class="chat-message clearfix">
                <div class="chat-message-type" img>
                        <button id="interested" class="btn btn-primary" style="margin-right:1%">I'm Interested</button><button id="available" class="btn btn-primary" style="margin-right:1%">Is This Still Available?</button>
                        <button id="thankyou" class="btn btn-primary" style="margin-right:1%">Thank You</button><button id="welcome" class="btn btn-primary" style="margin-right:1%">You're Welcome</button>
                        <br>
                        <br>
                        <textarea id="message" class="form-control" placeholder="Type your message here..." rows="3"></textarea>
                        <br>
                        <button class="fa fa-file-o"></button>
                        <button class="fa fa-file-image-o"></button>
                        <button id="send" class="btn btn-success">Send</button>
                        <br>
                        <br>
                        </div>
                        <br>
                </div>
        </div>
</div>
<script>
    var socket = io()
    $(() => {
        $("#send").click(()=>{
            var message = { name: "<%= user.name %>", message: $("#message").val()}
            postMessage(message)
            scrollDown();
        })
        $("#interested").click(()=>{
            var message = { name : "<%= user.name %>", message: $("#interested").html()}
            postMessage(message)
            scrollDown();
        })
        $("#available").click(()=>{
            var message = { name : "<%= user.name %>", message: $("#available").html()}
            postMessage(message)
            scrollDown();
        })
        $("#thankyou").click(()=>{
            var message = { name : "<%= user.name %>", message: $("#thankyou").html()}
            postMessage(message)
            scrollDown();
        })
        $("#welcome").click(()=>{
            var message = { name : "<%= user.name %>", message: $("#welcome").html()}
            postMessage(message)
            scrollDown();
        })
  
    })

    socket.on('message', addMessage)

    function addMessage(msg){
        $("#messages").append(`<h4> ${msg.name} </h4> <p> ${msg.message} </p>`)
        scrollDown();
    }

    function postMessage(message) {
        $.post('<%-url%>', message)
        scrollDown();
    }

    function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
    }
    window.onclick = function(event) {
    if (!event.target.matches('.dropbtn')) {

    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}
function scrollDown() {
    var objDiv = document.getElementById("chatroom");
    objDiv.scrollTop = objDiv.scrollHeight  ;
}
$(document).ready(function() {
    var objDiv = document.getElementById("chatroom");
    objDiv.scrollTop = objDiv.scrollHeight  ;
})
</script>
</body>
</html>